name: Maven Build & Docker

on:
  push:
    branches: [ main, dev ]
    paths:
      - 'backend/**'
  pull_request:
    branches: [ main, dev ]
    paths:
      - 'backend/**'

jobs:
  build:
    name: Build and test backend
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./backend
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'
        cache: maven
        cache-dependency-path: backend/pom.xml
    
    - name: Build and test with Maven
      run: ./mvnw -B verify
      
    - name: Upload test reports
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: backend-test-reports
        path: backend/target/surefire-reports/
        retention-days: 5
        
    - name: Docker build and push
      if: github.event_name != 'pull_request'
      env:
        REGISTRY_URL: registry.axelfrache.me
        REGISTRY_USER: ${{ secrets.HARBOR_USERNAME }}
        REGISTRY_PASSWORD: ${{ secrets.HARBOR_PASSWORD }}
        PROJECT_NAME: folior
        IMAGE_NAME: backend
        IMAGE_TAG: ${{ github.ref == 'refs/heads/main' && 'latest' || 'dev' }}
      run: |
        echo "$REGISTRY_PASSWORD" | docker login $REGISTRY_URL -u "$REGISTRY_USER" --password-stdin
        docker build -t $REGISTRY_URL/$PROJECT_NAME/$IMAGE_NAME:$IMAGE_TAG .
        docker push $REGISTRY_URL/$PROJECT_NAME/$IMAGE_NAME:$IMAGE_TAG
